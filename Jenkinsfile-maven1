pipeline {
     
        agent {
                label 'jenkins-node1'
            }

         environment {
		DOCKERHUB_CREDENTIALS=credentials('dockerhub')
	}  
        options { buildDiscarder(logRotator(artifactDaysToKeepStr: '',
     artifactNumToKeepStr: '', daysToKeepStr: '3', numToKeepStr: '5'))
      disableConcurrentBuilds() }



    stages {

stage('Setup parameters') {
            steps {
                script { 
                    properties([
                        parameters([
                            string(
                                defaultValue: 'maven-project', 
                                name: 'BranchName', 
                                trim: true
                            ),

                            string(
                                defaultValue: '001', 
                                name: 'ImageTAG', 
                                trim: true
                            )
                        ])
                    ])
                }
            }
        }



        stage('clean') {
            steps {
                sh '''
                mvn clean
                '''
            }
        }

        


stage('validate') {
            steps {
                sh '''
                mvn validate
                '''
            }
        }

stage('compile') {
            steps {
                 sh '''
                mvn compile
                '''
            }
        }

stage('test') {
            steps {
                 sh '''
                mvn test
                '''
            }
        }



stage('package') {
            steps {
                 sh '''
                mvn package
                '''
            }
        }


stage('install') {
            steps {
                 sh '''
                mvn install
                '''
            }
        }


stage('build ') {

            steps {
               sh '''
          sudo docker build -t devopseasylearning2021/kantin:$ImageTAG .
               '''
            }
        }



stage('Login') {

			steps {
				sh '''
                echo $DOCKERHUB_CREDENTIALS_PSW |sudo docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin
                '''
			}
		}

stage('Docker push ') {
            steps {
               sh '''
              sudo docker push devopseasylearning2021/kantin:$ImageTAG 
                '''
            }
        }



stage('Deploy to docker ') {
            steps {
               sh '''
               sudo docker rm -f checking || true
             sudo docker run -d -p 80:8080 devopseasylearning2021/kantin:$ImageTAG 
              curl ifconfig.co
                '''
            }
        }







}











}



